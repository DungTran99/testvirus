<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agent Dashboard t·ªïng h·ª£p</title>
<style>
  img { max-width: 300px; margin-bottom: 10px; }
  .card { display: inline-block; padding: 10px; border: 1px solid #ccc; margin: 10px; vertical-align: top; }
  table {border-collapse: collapse; width: 100%;}
  th, td {padding: 8px; border: 1px solid #ccc; text-align: left;}
  tr:hover {background-color: #f2f2f2;}
  #preview {max-width: 300px; max-height: 300px; margin-top: 10px; border: 1px solid #ccc;}
</style>
<script>
  function sendUninstall(hostname) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a client n√†y?")) return;
      fetch('/api/uninstall', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hostname })
      }).then(res => res.json()).then(data => {
          alert(data.message || "ƒê√£ g·ª≠i l·ªánh x√≥a.");
      });
  }

  async function loadImages() {
    const hostname = document.getElementById("filterHostname").value;
    const ip = document.getElementById("filterIP").value;
    const fromDate = document.getElementById("filterFromDate").value;
    const toDate = document.getElementById("filterToDate").value;

    let url = `/api/images?limit=50&offset=0`;
    if(hostname) url += `&hostname=${encodeURIComponent(hostname)}`;
    if(ip) url += `&ip=${encodeURIComponent(ip)}`;
    if(fromDate) url += `&from_date=${encodeURIComponent(fromDate)}`;
    if(toDate) url += `&to_date=${encodeURIComponent(toDate)}`;

    const res = await fetch(url);
    const data = await res.json();

    const tbody = document.querySelector("#imagesTable tbody");
    tbody.innerHTML = "";

    data.data.forEach(img => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${img.id}</td>
        <td>${img.hostname}</td>
        <td>${img.ip}</td>
        <td>${img.os}</td>
        <td>${img.mac}</td>
        <td>${new Date(img.timestamp).toLocaleString()}</td>
      `;
      tr.style.cursor = "pointer";
      tr.onclick = () => {
        document.getElementById("preview").src = `/image/${img.filename}`;
      }
      tbody.appendChild(tr);
    });
  }

  window.onload = () => {
    loadImages();
  }
</script>
</head>
<body>

<h1>Dashboard qu·∫£n l√Ω ·∫£nh g·ª≠i l√™n</h1>

<!-- Ph·∫ßn filter & b·∫£ng ·∫£nh -->
<label>Hostname: <input type="text" id="filterHostname" /></label>
<label>IP: <input type="text" id="filterIP" /></label>
<label>T·ª´ ng√†y: <input type="date" id="filterFromDate" /></label>
<label>ƒê·∫øn ng√†y: <input type="date" id="filterToDate" /></label>
<button onclick="loadImages()">T√¨m ki·∫øm</button>

<table id="imagesTable">
<thead>
  <tr><th>ID</th><th>Hostname</th><th>IP</th><th>OS</th><th>MAC</th><th>Timestamp</th></tr>
</thead>
<tbody></tbody>
</table>

<h3>·∫¢nh xem tr∆∞·ªõc:</h3>
<img id="preview" src="" alt="Ch·ªçn ·∫£nh ƒë·ªÉ xem" />

<hr>

<!-- Ph·∫ßn recent ·∫£nh d·∫°ng card -->
<h2>·∫¢nh nh·∫≠n g·∫ßn ƒë√¢y</h2>
<div id="recentImagesContainer">
  <!-- ƒê√¢y l√† ph·∫ßn server render, v√≠ d·ª• v·ªõi template engine -->
  {% for img in images %}
  <div class="card">
      <strong>{{ img.hostname }}</strong><br>
      {{ img.timestamp }}<br>
      <img src="/image/{{ img.filename }}"><br>
      <button onclick="sendUninstall('{{ img.hostname }}')">üóëÔ∏è G·ª° client</button>
  </div>
  {% endfor %}
</div>

</body>
</html>
